# Thu·∫≠t To√°n T√≠nh Gi·ªù L√†m Vi·ªác - Chi Ti·∫øt ƒê·∫ßy ƒê·ªß

## üìã Quy T·∫Øc C∆° B·∫£n

### 1. C√°c Lo·∫°i Ca L√†m Vi·ªác
| Shift Type | Gi·ªù L√†m | Ngh·ªâ Tr∆∞a | Cho ph√©p OT | Ghi ch√∫ |
|------------|---------|-----------|-------------|---------|
| **Day** | 8:00-17:00 | 12:00-13:00 | ‚úÖ C√≥ | M·∫∑c ƒë·ªãnh |
| **Canteen** | 7:00-16:00 | 11:00-12:00 | ‚úÖ C√≥ | Group = Canteen |
| **Shift 1** | 6:00-14:00 | 10:00-10:00 | ‚ùå Kh√¥ng | ƒêƒÉng k√Ω ri√™ng |
| **Shift 2** | 14:00-22:00 | 18:00-18:00 | ‚ùå Kh√¥ng | ƒêƒÉng k√Ω ri√™ng |

### 2. Th√¥ng Tin Output ƒê·∫ßy ƒê·ªß
```json
{
  "morning_hours": 4.0,           // Gi·ªù l√†m bu·ªïi s√°ng
  "afternoon_hours": 4.0,         // Gi·ªù l√†m bu·ªïi chi·ªÅu
  "actual_overtime": 2.5,         // TƒÉng ca th·ª±c t·∫ø (pre + post)
  "approved_overtime": 3.0,       // TƒÉng ca ƒë∆∞·ª£c duy·ªát
  "final_overtime": 2.5,          // min(actual, approved)
  "total_hours": 10.5             // s√°ng + chi·ªÅu + final_ot
}
```

## üîÑ S∆° ƒê·ªì Thu·∫≠t To√°n Chi Ti·∫øt

```mermaid
graph TD
    A[B·∫Øt ƒë·∫ßu: Check In/Out] --> B{C√≥ ƒë·ªß d·ªØ li·ªáu?}
    B -->|Kh√¥ng| Z[T·∫•t c·∫£ = 0]
    B -->|C√≥| C[X√°c ƒë·ªãnh Shift Type]
    
    C --> D[L·∫•y th√¥ng tin ca]
    D --> E[T√≠nh Gi·ªù Bu·ªïi S√°ng]
    E --> F[T√≠nh Gi·ªù Bu·ªïi Chi·ªÅu]
    F --> G[T√≠nh TƒÉng Ca Th·ª±c T·∫ø]
    G --> H[L·∫•y TƒÉng Ca ƒê∆∞·ª£c Duy·ªát]
    H --> I[T√≠nh Final OT]
    I --> J[T√≠nh T·ªïng]
    
    E --> E1{Check in tr∆∞·ªõc<br/>gi·ªù b·∫Øt ƒë·∫ßu s√°ng?}
    E1 -->|C√≥| E2[T√≠nh t·ª´ gi·ªù b·∫Øt ƒë·∫ßu ca]
    E1 -->|Kh√¥ng| E3[T√≠nh t·ª´ check in]
    E2 --> E4[Morning = min(break_start - shift_start, check_out - shift_start)]
    E3 --> E4
    
    F --> F1{Check out sau<br/>gi·ªù k·∫øt th√∫c chi·ªÅu?}
    F1 -->|C√≥| F2[T√≠nh ƒë·∫øn gi·ªù k·∫øt th√∫c ca]
    F1 -->|Kh√¥ng| F3[T√≠nh ƒë·∫øn check out]
    F2 --> F4[Afternoon = min(shift_end - break_end, check_out - break_end)]
    F3 --> F4
    
    G --> G1[Pre-shift OT:<br/>Gi·ªù tr∆∞·ªõc ca]
    G1 --> G2[Post-shift OT:<br/>Gi·ªù sau ca]
    G2 --> G3[Actual OT = Pre + Post]
    
    H --> H1{Shift 1/2?}
    H1 -->|C√≥| H2[Approved OT = 0]
    H1 -->|Kh√¥ng| H3[L·∫•y t·ª´ OT Registration]
    
    I --> I1[Final OT = min(Actual, Approved)]
    J --> J1[Total = Morning + Afternoon + Final OT]
```

## ‚öôÔ∏è Chi Ti·∫øt Thu·∫≠t To√°n

### B∆∞·ªõc 1: T√≠nh Gi·ªù Bu·ªïi S√°ng
```python
def calculate_morning_hours(check_in, check_out, shift_config):
    shift_start = shift_config["start_time"]
    break_start = shift_config["break_start"] 
    
    # X·ª≠ l√Ω ƒëi s·ªõm: t√≠nh t·ª´ shift_start
    morning_start = max(check_in, shift_start)
    morning_end = min(check_out, break_start)
    
    if morning_end > morning_start:
        return (morning_end - morning_start).total_seconds() / 3600
    return 0.0
```

### B∆∞·ªõc 2: T√≠nh Gi·ªù Bu·ªïi Chi·ªÅu  
```python
def calculate_afternoon_hours(check_in, check_out, shift_config):
    break_end = shift_config["break_end"]
    shift_end = shift_config["end_time"]
    
    # X·ª≠ l√Ω v·ªÅ tr·ªÖ: ch·ªâ t√≠nh ƒë·∫øn shift_end cho gi·ªù b√¨nh th∆∞·ªùng
    afternoon_start = max(check_in, break_end)
    afternoon_end = min(check_out, shift_end)
    
    if afternoon_end > afternoon_start:
        return (afternoon_end - afternoon_start).total_seconds() / 3600
    return 0.0
```

### B∆∞·ªõc 3: T√≠nh TƒÉng Ca Th·ª±c T·∫ø
```python
def calculate_actual_overtime(check_in, check_out, shift_config):
    shift_start = shift_config["start_time"]
    shift_end = shift_config["end_time"]
    
    pre_shift_ot = 0.0
    post_shift_ot = 0.0
    
    # Pre-shift OT: ƒêi s·ªõm h∆°n gi·ªù b·∫Øt ƒë·∫ßu ca
    if check_in < shift_start:
        pre_shift_ot = (shift_start - check_in).total_seconds() / 3600
    
    # Post-shift OT: V·ªÅ tr·ªÖ h∆°n gi·ªù k·∫øt th√∫c ca  
    if check_out > shift_end:
        post_shift_ot = (check_out - shift_end).total_seconds() / 3600
    
    return pre_shift_ot + post_shift_ot
```

### B∆∞·ªõc 4: L·∫•y TƒÉng Ca ƒê∆∞·ª£c Duy·ªát
```python
def get_approved_overtime(employee, date, shift_type):
    # Shift 1, 2: Kh√¥ng bao gi·ªù c√≥ approved OT
    if shift_type in ['Shift 1', 'Shift 2']:
        return 0.0
    
    # Day, Canteen: L·∫•y t·ª´ OT Registration
    ot_registrations = frappe.get_all(
        "Overtime Registration Detail",
        filters={"employee": employee, "date": date},
        fields=["begin_time", "end_time"]
    )
    
    total_approved = 0.0
    for ot in ot_registrations:
        hours = (ot.end_time - ot.begin_time).total_seconds() / 3600
        total_approved += hours
    
    return total_approved
```

### B∆∞·ªõc 5: T√≠nh Final OT v√† T·ªïng
```python
def calculate_final_results(morning, afternoon, actual_ot, approved_ot):
    final_overtime = min(actual_ot, approved_ot)
    total_hours = morning + afternoon + final_overtime
    
    return {
        "morning_hours": morning,
        "afternoon_hours": afternoon, 
        "actual_overtime": actual_ot,
        "approved_overtime": approved_ot,
        "final_overtime": final_overtime,
        "total_hours": total_hours
    }
```

## üìù V√≠ D·ª• Chi Ti·∫øt

### V√≠ D·ª• 1: Ca Day - ƒêi S·ªõm, V·ªÅ Tr·ªÖ
```
Employee: John (Group: th∆∞·ªùng)
Shift: Day (8:00-17:00, Break: 12:00-13:00)
Check in: 7:00, Check out: 19:00
OT Registration: 7:00-8:00 (1h), 17:00-18:00 (1h) = T·ªïng 2h

T√≠nh to√°n:
‚Üí Morning: max(7:00, 8:00) to 12:00 = 8:00-12:00 = 4h
‚Üí Afternoon: 13:00 to min(19:00, 17:00) = 13:00-17:00 = 4h  
‚Üí Actual OT: (8:00-7:00) + (19:00-17:00) = 1h + 2h = 3h
‚Üí Approved OT: 1h + 1h = 2h
‚Üí Final OT: min(3h, 2h) = 2h
‚Üí Total: 4h + 4h + 2h = 10h
```

### V√≠ D·ª• 2: Ca Canteen - ƒêi ƒê√∫ng Gi·ªù, V·ªÅ Tr·ªÖ
```
Employee: Mary (Group: Canteen)
Shift: Canteen (7:00-16:00, Break: 11:00-12:00)  
Check in: 7:00, Check out: 18:00
OT Registration: 16:00-18:00 (2h) = T·ªïng 2h

T√≠nh to√°n:
‚Üí Morning: 7:00-11:00 = 4h
‚Üí Afternoon: 12:00 to min(18:00, 16:00) = 12:00-16:00 = 4h
‚Üí Actual OT: 0h + (18:00-16:00) = 2h
‚Üí Approved OT: 2h  
‚Üí Final OT: min(2h, 2h) = 2h
‚Üí Total: 4h + 4h + 2h = 10h
```

### V√≠ D·ª• 3: Shift 1 - ƒêi S·ªõm, V·ªÅ Tr·ªÖ (Kh√¥ng OT)
```
Employee: Peter (ƒêƒÉng k√Ω Shift 1)
Shift: Shift 1 (6:00-14:00, Break: 10:00-10:00)
Check in: 5:30, Check out: 15:00
OT Registration: Kh√¥ng c√≥

T√≠nh to√°n:
‚Üí Morning: max(5:30, 6:00) to 10:00 = 6:00-10:00 = 4h
‚Üí Afternoon: 10:00 to min(15:00, 14:00) = 10:00-14:00 = 4h
‚Üí Actual OT: (6:00-5:30) + (15:00-14:00) = 0.5h + 1h = 1.5h
‚Üí Approved OT: 0h (Shift 1 kh√¥ng ƒë∆∞·ª£c ph√©p)
‚Üí Final OT: min(1.5h, 0h) = 0h
‚Üí Total: 4h + 4h + 0h = 8h
```

### V√≠ D·ª• 4: Ca Day - ƒêi Mu·ªôn, V·ªÅ S·ªõm
```
Employee: Anna (Group: th∆∞·ªùng)
Shift: Day (8:00-17:00, Break: 12:00-13:00)
Check in: 8:30, Check out: 16:30  
OT Registration: Kh√¥ng c√≥

T√≠nh to√°n:
‚Üí Morning: 8:30-12:00 = 3.5h
‚Üí Afternoon: 13:00-16:30 = 3.5h
‚Üí Actual OT: 0h + 0h = 0h (kh√¥ng ƒëi s·ªõm, kh√¥ng v·ªÅ tr·ªÖ)
‚Üí Approved OT: 0h
‚Üí Final OT: min(0h, 0h) = 0h  
‚Üí Total: 3.5h + 3.5h + 0h = 7h
```

### V√≠ D·ª• 5: Ca Day - OT V∆∞·ª£t Qu√° Approved
```
Employee: Tom (Group: th∆∞·ªùng)
Shift: Day (8:00-17:00, Break: 12:00-13:00)
Check in: 6:00, Check out: 20:00
OT Registration: 17:00-18:00 (1h) = T·ªïng 1h

T√≠nh to√°n:
‚Üí Morning: max(6:00, 8:00) to 12:00 = 8:00-12:00 = 4h
‚Üí Afternoon: 13:00-17:00 = 4h
‚Üí Actual OT: (8:00-6:00) + (20:00-17:00) = 2h + 3h = 5h
‚Üí Approved OT: 1h
‚Üí Final OT: min(5h, 1h) = 1h (ch·ªâ t√≠nh theo approved)
‚Üí Total: 4h + 4h + 1h = 9h
```

## üìä Ma Tr·∫≠n K·∫øt Qu·∫£ Chi Ti·∫øt

### Ca Day (8:00-17:00, Break: 12:00-13:00)
| Scenario | Check In/Out | Morning | Afternoon | Actual OT | Approved OT | Final OT | Total |
|----------|--------------|---------|-----------|-----------|-------------|----------|-------|
| **B√¨nh th∆∞·ªùng** | 8:00‚Üí17:00 | 4h | 4h | 0h | 0h | 0h | **8h** |
| **ƒêi s·ªõm** | 7:00‚Üí17:00 | 4h | 4h | 1h | 1h* | 1h | **9h** |
| **V·ªÅ tr·ªÖ** | 8:00‚Üí19:00 | 4h | 4h | 2h | 2h* | 2h | **10h** |
| **ƒêi s·ªõm + v·ªÅ tr·ªÖ** | 7:00‚Üí19:00 | 4h | 4h | 3h | 2h* | 2h | **10h** |
| **ƒêi mu·ªôn** | 8:30‚Üí17:00 | 3.5h | 4h | 0h | 0h | 0h | **7.5h** |
| **V·ªÅ s·ªõm** | 8:00‚Üí16:00 | 4h | 3h | 0h | 0h | 0h | **7h** |
| **OT v∆∞·ª£t** | 7:00‚Üí20:00 | 4h | 4h | 5h | 1h* | 1h | **9h** |

*\* Gi·∫£ s·ª≠ c√≥ ƒëƒÉng k√Ω OT*

### Shift 1 (6:00-14:00, Break: 10:00-10:00) - Kh√¥ng OT
| Scenario | Check In/Out | Morning | Afternoon | Actual OT | Approved OT | Final OT | Total |
|----------|--------------|---------|-----------|-----------|-------------|----------|-------|
| **B√¨nh th∆∞·ªùng** | 6:00‚Üí14:00 | 4h | 4h | 0h | 0h | 0h | **8h** |
| **ƒêi s·ªõm** | 5:00‚Üí14:00 | 4h | 4h | 1h | 0h | 0h | **8h** |
| **V·ªÅ tr·ªÖ** | 6:00‚Üí16:00 | 4h | 4h | 2h | 0h | 0h | **8h** |
| **C·∫£ hai** | 5:00‚Üí16:00 | 4h | 4h | 3h | 0h | 0h | **8h** |

## üîß Code Implementation Ho√†n Ch·ªânh

```python
def calculate_attendance_full_details(employee, date, check_in, check_out):
    """
    T√≠nh to√°n ƒë·∫ßy ƒë·ªß th√¥ng tin ch·∫•m c√¥ng
    Returns: Dict v·ªõi t·∫•t c·∫£ th√¥ng tin chi ti·∫øt
    """
    
    if not check_in or not check_out:
        return {
            "morning_hours": 0.0,
            "afternoon_hours": 0.0, 
            "actual_overtime": 0.0,
            "approved_overtime": 0.0,
            "final_overtime": 0.0,
            "total_hours": 0.0
        }
    
    # B∆∞·ªõc 1: X√°c ƒë·ªãnh ca l√†m vi·ªác
    shift_type = get_employee_shift_type(employee, date)
    shift_config = SHIFT_CONFIGS[shift_type]
    
    # B∆∞·ªõc 2: T√≠nh gi·ªù bu·ªïi s√°ng
    morning_hours = calculate_morning_hours(check_in, check_out, shift_config)
    
    # B∆∞·ªõc 3: T√≠nh gi·ªù bu·ªïi chi·ªÅu
    afternoon_hours = calculate_afternoon_hours(check_in, check_out, shift_config)
    
    # B∆∞·ªõc 4: T√≠nh tƒÉng ca th·ª±c t·∫ø (pre + post shift)
    actual_overtime = calculate_actual_overtime(check_in, check_out, shift_config)
    
    # B∆∞·ªõc 5: L·∫•y tƒÉng ca ƒë∆∞·ª£c duy·ªát
    approved_overtime = get_approved_overtime(employee, date, shift_type)
    
    # B∆∞·ªõc 6: T√≠nh final overtime
    final_overtime = min(actual_overtime, approved_overtime)
    
    # B∆∞·ªõc 7: T√≠nh t·ªïng
    total_hours = morning_hours + afternoon_hours + final_overtime
    
    return {
        "shift_type": shift_type,
        "morning_hours": round(morning_hours, 2),
        "afternoon_hours": round(afternoon_hours, 2),
        "actual_overtime": round(actual_overtime, 2),
        "approved_overtime": round(approved_overtime, 2), 
        "final_overtime": round(final_overtime, 2),
        "total_hours": round(total_hours, 2),
        "breakdown": f"{morning_hours:.1f}h s√°ng + {afternoon_hours:.1f}h chi·ªÅu + {final_overtime:.1f}h OT = {total_hours:.1f}h"
    }

def calculate_morning_hours(check_in, check_out, shift_config):
    """T√≠nh gi·ªù l√†m bu·ªïi s√°ng"""
    shift_start = shift_config["start_time"]
    break_start = shift_config["break_start"]
    
    # X·ª≠ l√Ω ƒëi s·ªõm: kh√¥ng t√≠nh tr∆∞·ªõc shift_start v√†o gi·ªù b√¨nh th∆∞·ªùng
    morning_start = max(check_in, shift_start)
    morning_end = min(check_out, break_start)
    
    if morning_end > morning_start:
        return (morning_end - morning_start).total_seconds() / 3600
    return 0.0

def calculate_afternoon_hours(check_in, check_out, shift_config):
    """T√≠nh gi·ªù l√†m bu·ªïi chi·ªÅu"""  
    break_end = shift_config["break_end"]
    shift_end = shift_config["end_time"]
    
    # X·ª≠ l√Ω v·ªÅ tr·ªÖ: kh√¥ng t√≠nh sau shift_end v√†o gi·ªù b√¨nh th∆∞·ªùng
    afternoon_start = max(check_in, break_end)
    afternoon_end = min(check_out, shift_end)
    
    if afternoon_end > afternoon_start:
        return (afternoon_end - afternoon_start).total_seconds() / 3600
    return 0.0

def calculate_actual_overtime(check_in, check_out, shift_config):
    """T√≠nh tƒÉng ca th·ª±c t·∫ø (pre-shift + post-shift)"""
    shift_start = shift_config["start_time"] 
    shift_end = shift_config["end_time"]
    
    pre_shift_ot = 0.0
    post_shift_ot = 0.0
    
    # Pre-shift OT: l√†m tr∆∞·ªõc gi·ªù b·∫Øt ƒë·∫ßu ca
    if check_in < shift_start:
        pre_shift_ot = (shift_start - check_in).total_seconds() / 3600
    
    # Post-shift OT: l√†m sau gi·ªù k·∫øt th√∫c ca
    if check_out > shift_end:
        post_shift_ot = (check_out - shift_end).total_seconds() / 3600
    
    return pre_shift_ot + post_shift_ot

def get_approved_overtime(employee, date, shift_type):
    """L·∫•y t·ªïng tƒÉng ca ƒë∆∞·ª£c duy·ªát"""
    
    # Shift 1, 2: Kh√¥ng bao gi·ªù c√≥ approved OT
    if shift_type in ['Shift 1', 'Shift 2']:
        return 0.0
    
    # Day, Canteen: T√≠nh t·ªïng t·ª´ OT Registration
    ot_registrations = frappe.get_all(
        "Overtime Registration Detail",
        filters={
            "employee": employee, 
            "date": date,
            "parenttype": "Overtime Registration"
        },
        fields=["begin_time", "end_time"]
    )
    
    total_approved = 0.0
    for ot in ot_registrations:
        duration = (ot.end_time - ot.begin_time).total_seconds() / 3600
        total_approved += duration
    
    return total_approved

# Hook v√†o Attendance doctype
def before_save(doc, method):
    """Auto-calculate v·ªõi th√¥ng tin ƒë·∫ßy ƒë·ªß khi save"""
    if doc.check_in and doc.check_out:
        result = calculate_attendance_full_details(
            doc.employee,
            doc.attendance_date, 
            doc.check_in,
            doc.check_out
        )
        
        # Update c√°c fields
        doc.shift_type = result["shift_type"]
        doc.custom_morning_hours = result["morning_hours"]
        doc.custom_afternoon_hours = result["afternoon_hours"] 
        doc.custom_actual_overtime = result["actual_overtime"]
        doc.custom_approved_overtime = result["approved_overtime"]
        doc.custom_final_overtime = result["final_overtime"]
        doc.working_hours = result["total_hours"]
        doc.custom_breakdown = result["breakdown"]
```

## üìã Custom Fields C·∫ßn T·∫°o

### Trong Attendance DocType:
```python
custom_fields = [
    {
        "fieldname": "custom_morning_hours",
        "fieldtype": "Float", 
        "label": "Morning Hours",
        "precision": 2
    },
    {
        "fieldname": "custom_afternoon_hours", 
        "fieldtype": "Float",
        "label": "Afternoon Hours", 
        "precision": 2
    },
    {
        "fieldname": "custom_actual_overtime",
        "fieldtype": "Float",
        "label": "Actual Overtime",
        "precision": 2
    },
    {
        "fieldname": "custom_approved_overtime",
        "fieldtype": "Float", 
        "label": "Approved Overtime",
        "precision": 2
    },
    {
        "fieldname": "custom_final_overtime",
        "fieldtype": "Float",
        "label": "Final Overtime", 
        "precision": 2
    },
    {
        "fieldname": "custom_breakdown",
        "fieldtype": "Data",
        "label": "Hours Breakdown"
    }
]
``` 