# Thu·∫≠t To√°n Ch·∫•m C√¥ng  

## üéØ T·ªïng Quan

### M·ª•c Ti√™u
T√≠nh to√°n **ƒë·∫ßy ƒë·ªß v√† ch√≠nh x√°c** c√°c th√¥ng tin ch·∫•m c√¥ng:
- ‚úÖ Gi·ªù l√†m bu·ªïi s√°ng
- ‚úÖ Gi·ªù l√†m bu·ªïi chi·ªÅu  
- ‚úÖ Gi·ªù tƒÉng ca th·ª±c t·∫ø (pre + post shift)
- ‚úÖ Gi·ªù tƒÉng ca ƒë∆∞·ª£c duy·ªát
- ‚úÖ T·ªïng gi·ªù = s√°ng + chi·ªÅu + min(approved, actual) OT

### Nguy√™n T·∫Øc ƒê∆°n Gi·∫£n
1. **Ch·ªâ 2 ca ƒë∆∞·ª£c ph√©p OT**: Day v√† Canteen
2. **Shift 1, 2 kh√¥ng bao gi·ªù OT**: D√π l√†m vi·ªác ƒë·∫øn m·∫•y gi·ªù
3. **Maternity benefit**: Pregnant/Young child ƒë∆∞·ª£c v·ªÅ s·ªõm 1h

## üìã Quy T·∫Øc C∆° B·∫£n

| Shift Type | Gi·ªù L√†m | Ngh·ªâ Tr∆∞a | OT | Maternity Benefit |
|------------|---------|-----------|----|--------------------|
| **Day** | 8:00-17:00 | 12:00-13:00 | ‚úÖ | ‚úÖ V·ªÅ 16:00 = 8h |
| **Canteen** | 7:00-16:00 | 11:00-12:00 | ‚úÖ | ‚úÖ V·ªÅ 15:00 = 8h |
| **Shift 1** | 6:00-14:00 | 10:00=10:00 | ‚ùå | ‚úÖ V·ªÅ 13:00 = 8h |
| **Shift 2** | 14:00-22:00 | 18:00=18:00 | ‚ùå | ‚úÖ V·ªÅ 21:00 = 8h |

## üîÑ S∆° ƒê·ªì Thu·∫≠t To√°n

```
1. INPUT: Employee, Date, Check In, Check Out
           ‚Üì
2. X√°c ƒë·ªãnh Shift Type (Registration > Group > Default)
           ‚Üì
3. Check Maternity Benefit (Pregnant/Young Child trong date range)
           ‚Üì
4. T√≠nh Morning Hours (t·ª´ shift_start ƒë·∫øn break_start)
           ‚Üì
5. T√≠nh Afternoon Hours (t·ª´ break_end ƒë·∫øn shift_end, c√≥ √°p d·ª•ng maternity)
           ‚Üì
6. T√≠nh Actual OT (pre-shift + post-shift, theo original shift time)
           ‚Üì
7. L·∫•y Approved OT (t·ª´ OT Registration, Shift 1/2 = 0)
           ‚Üì
8. Final OT = min(Actual, Approved)
           ‚Üì
9. Total = Morning + Afternoon + Final OT
```

## ‚öôÔ∏è Logic Chi Ti·∫øt

### 1. X√°c ƒê·ªãnh Shift Type
```python
if c√≥ shift_registration_detail:
    return registered_shift_type
elif employee.custom_group == "Canteen":
    return "Canteen" 
else:
    return "Day"  # M·∫∑c ƒë·ªãnh
```

### 2. Check Maternity Benefit
```python
def has_maternity_benefit(employee, date):
    records = get_maternity_tracking(employee, date)
    return any(r.type in ["Pregnant", "Young child"] for r in records)
```

### 3. T√≠nh Morning Hours
```python
morning_start = max(check_in, shift_start)  # Kh√¥ng t√≠nh ƒëi s·ªõm
morning_end = min(check_out, break_start)
morning_hours = max(0, morning_end - morning_start)
```

### 4. T√≠nh Afternoon Hours (C√≥ Maternity)
```python
afternoon_start = max(check_in, break_end)

if has_maternity_benefit:
    # ƒê∆∞·ª£c v·ªÅ s·ªõm 1h m√† v·∫´n t√≠nh ƒë·ªß gi·ªù
    if check_out >= (shift_end - 1h):
        afternoon_end = shift_end  # T√≠nh ƒë·ªß gi·ªù
    else:
        afternoon_end = min(check_out, shift_end)  # T√≠nh th·ª±c t·∫ø
else:
    afternoon_end = min(check_out, shift_end)

afternoon_hours = max(0, afternoon_end - afternoon_start)
```

### 5. T√≠nh Actual OT
```python
pre_shift_ot = max(0, shift_start - check_in)    # ƒêi s·ªõm
post_shift_ot = max(0, check_out - shift_end)    # V·ªÅ tr·ªÖ
actual_ot = pre_shift_ot + post_shift_ot
```

### 6. T√≠nh Approved OT
```python
if shift_type in ["Shift 1", "Shift 2"]:
    approved_ot = 0  # Kh√¥ng bao gi·ªù ƒë∆∞·ª£c ph√©p OT
else:
    approved_ot = sum(ot_registrations)  # T·ª´ b·∫£ng ƒëƒÉng k√Ω
```

### 7. K·∫øt Qu·∫£ Final
```python
final_ot = min(actual_ot, approved_ot)
total_hours = morning_hours + afternoon_hours + final_ot
```

## üìä Ma Tr·∫≠n K·∫øt Qu·∫£

### Ca Day (8:00-17:00) - C√°c Tr∆∞·ªùng H·ª£p Ch√≠nh

| Scenario | Check In/Out | Maternity | Morning | Afternoon | Actual OT | Approved OT | Final OT | Total |
|----------|--------------|-----------|---------|-----------|-----------|-------------|----------|-------|
| **B√¨nh th∆∞·ªùng** | 8:00‚Üí17:00 | ‚ùå | 4h | 4h | 0h | 0h | 0h | **8h** |
| **Pregnant benefit** | 8:00‚Üí16:00 | ‚úÖ | 4h | **4h** ‚ú® | 0h | 0h | 0h | **8h** |
| **C√≥ OT** | 7:00‚Üí19:00 | ‚ùå | 4h | 4h | 3h | 2h* | 2h | **10h** |
| **Pregnant + OT** | 7:00‚Üí18:00 | ‚úÖ | 4h | **4h** ‚ú® | 2h | 2h* | 2h | **10h** |
| **ƒêi mu·ªôn** | 8:30‚Üí17:00 | ‚ùå | 3.5h | 4h | 0h | 0h | 0h | **7.5h** |
| **V·ªÅ s·ªõm** | 8:00‚Üí15:00 | ‚ùå | 4h | 2h | 0h | 0h | 0h | **6h** |

*‚ú® = √Åp d·ª•ng Maternity Benefit*  
*\* = C√≥ ƒëƒÉng k√Ω OT*

### So S√°nh Shift 1/2 vs Day/Canteen

| Shift Type | Employee | Check In/Out | Actual OT | Approved OT | Final OT | Total |
|------------|----------|--------------|-----------|-------------|----------|-------|
| **Day** | B√¨nh th∆∞·ªùng | 8:00‚Üí19:00 | 2h | 2h* | 2h | **10h** |
| **Shift 1** | B√¨nh th∆∞·ªùng | 6:00‚Üí16:00 | 2h | **0h** | **0h** | **8h** |
| **Canteen** | B√¨nh th∆∞·ªùng | 7:00‚Üí18:00 | 2h | 2h* | 2h | **10h** |
| **Shift 2** | B√¨nh th∆∞·ªùng | 14:00‚Üí24:00 | 2h | **0h** | **0h** | **8h** |

## ü§± Maternity Benefit - Chi Ti·∫øt

### ƒêi·ªÅu Ki·ªán √Åp D·ª•ng
```sql
SELECT * FROM `tabMaternity Tracking` 
WHERE parent = employee
  AND type IN ('Pregnant', 'Young child')
  AND from_date <= attendance_date 
  AND to_date >= attendance_date
```

### C√°ch Ho·∫°t ƒê·ªông
```
Ca Day: 8:00-17:00 ‚Üí Pregnant employee ƒë∆∞·ª£c v·ªÅ 16:00

Normal Employee: 8:00‚Üí16:00 = 7h (thi·∫øu 1h)
Pregnant Employee: 8:00‚Üí16:00 = 8h (ƒë·ªß gi·ªù) ‚ú®

Nh∆∞ng:
Pregnant Employee: 8:00‚Üí15:00 = 6h (v·∫´n thi·∫øu v√¨ v·ªÅ qu√° s·ªõm)
```

### Kh√¥ng ·∫¢nh H∆∞·ªüng OT
```
Pregnant Employee: 8:00‚Üí18:00 v·ªõi OT 17:00-18:00

‚Üí Morning: 4h
‚Üí Afternoon: 4h (benefit applied)  
‚Üí Actual OT: 1h (18:00 - 17:00, theo original shift)
‚Üí Approved OT: 1h
‚Üí Final OT: 1h
‚Üí Total: 9h
```

## ‚öôÔ∏è Constants & Configuration (Latest Update)

### Minimum Thresholds
```python
# Constants for minimum thresholds
MIN_MINUTES_OT = 15                    # T·ªïng OT < 15 ph√∫t ‚Üí Set = 0
MIN_MINUTES_WORKING_HOURS = 10         # Working hours < 10 ph√∫t ‚Üí Set = 0  
MIN_MINUTES_PRE_SHIFT_OT = 60          # OT tr∆∞·ªõc ca < 60 ph√∫t ‚Üí Set = 0
MIN_MINUTES_CHECKIN_FILTER = 10        # Filter checkin < 10 ph√∫t (thay v√¨ 30 ph√∫t)
```

### Enhanced Logic Improvements

#### 1. Multiple Checkin Handling
```python
# OLD: Filter < 30 ph√∫t (qu√° strict, lo·∫°i b·ªè checkin h·ª£p l·ªá)
if time_diff >= 30:  # Too strict!

# NEW: Filter < 10 ph√∫t (√≠t strict h∆°n, gi·ªØ l·∫°i checkin h·ª£p l·ªá)
if time_diff >= MIN_MINUTES_CHECKIN_FILTER:  # More flexible!

# Logic: S·ªõm nh·∫•t = Check In, Mu·ªôn nh·∫•t = Check Out
check_in = filtered_checkins[0].check_time      # S·ªõm nh·∫•t
check_out = filtered_checkins[-1].check_time    # Mu·ªôn nh·∫•t
```

#### 2. Special Working Hours Case
```python
def calculate_morning_hours(check_in, check_out, shift_config):
    """Special case: Check in tr∆∞·ªõc ca & check out tr∆∞·ªõc ngh·ªâ tr∆∞a"""
    
    # Special case logic
    if check_in < shift_start and check_out <= break_start:
        # Working hours = check out - b·∫Øt ƒë·∫ßu ca (KH√îNG ph·∫£i check in)
        if check_out > shift_start:
            return time_diff_in_hours(check_out, shift_start)
        else:
            return 0
    
    # Normal case: logic c≈©
    morning_start = max(check_in, shift_start)
    morning_end = min(check_out, break_start)
    return time_diff_in_hours(morning_end, morning_start)
```

#### 3. Constants-Based Thresholds
```python
# OT Calculation v·ªõi constants
def calculate_actual_overtime(...):
    pre_shift_ot = time_diff_in_hours(shift_start, check_in)
    
    # OLD: Hardcode if pre_shift_ot < 1:
    # NEW: Constants-based
    if pre_shift_ot * 60 < MIN_MINUTES_PRE_SHIFT_OT:
        pre_shift_ot = 0
    
    total_ot = pre_shift_ot + post_shift_ot
    
    # Apply minimum OT threshold
    if total_ot * 60 < MIN_MINUTES_OT:
        total_ot = 0
    
    return total_ot

# Working Hours v·ªõi constants  
def calculate_all_fields(...):
    total_working_hours = morning_hours + afternoon_hours
    
    # Apply minimum working hours threshold
    if total_working_hours * 60 < MIN_MINUTES_WORKING_HOURS:
        total_working_hours = 0
    
    self.working_hours = self.decimal_round(total_working_hours)
```

#### 4. Real-time Algorithm Dialog
```javascript
// JavaScript gets constants from server
frappe.call({
    method: "...get_algorithm_constants",
    callback: function(r) {
        const constants = r.message;
        
        // Use in dialog template
        `<li><strong>Ng∆∞·ª°ng t·ªëi thi·ªÉu:</strong> Working hours < ${constants.MIN_MINUTES_WORKING_HOURS} ph√∫t ‚Üí Set = 0</li>`
        `<li><strong>OT tr∆∞·ªõc ca t·ªëi thi·ªÉu:</strong> ${constants.MIN_MINUTES_PRE_SHIFT_OT} ph√∫t</li>`
        `<li><strong>Filter checkin:</strong> < ${constants.MIN_MINUTES_CHECKIN_FILTER} ph√∫t</li>`
        `<li><strong>Ng∆∞·ª°ng OT:</strong> < ${constants.MIN_MINUTES_OT} ph√∫t ‚Üí Set = 0</li>`
    }
});
```

## üíª Implementation Code

```python
def calculate_attendance_simple(employee, date, check_in, check_out):
    """Main function - t√≠nh to√°n ƒë·∫ßy ƒë·ªß th√¥ng tin"""
    
    # 1. X√°c ƒë·ªãnh shift type
    shift_type = get_shift_type(employee, date)
    shift_config = SHIFTS[shift_type]
    
    # 2. Check maternity benefit  
    has_maternity = check_maternity_benefit(employee, date)
    
    # 3. T√≠nh morning hours
    morning = calculate_morning(check_in, check_out, shift_config)
    
    # 4. T√≠nh afternoon hours (c√≥ maternity)
    afternoon = calculate_afternoon(check_in, check_out, shift_config, has_maternity)
    
    # 5. T√≠nh actual OT
    actual_ot = calculate_actual_ot(check_in, check_out, shift_config)
    
    # 6. L·∫•y approved OT
    approved_ot = get_approved_ot(employee, date, shift_type)
    
    # 7. Final calculation
    final_ot = min(actual_ot, approved_ot)
    total = morning + afternoon + final_ot
    
    return {
        "morning_hours": morning,
        "afternoon_hours": afternoon,
        "actual_overtime": actual_ot, 
        "approved_overtime": approved_ot,
        "final_overtime": final_ot,
        "total_hours": total,
        "maternity_benefit": has_maternity
    }

# Configuration
SHIFTS = {
    "Day": {
        "start": "08:00", "end": "17:00",
        "break_start": "12:00", "break_end": "13:00",
        "allows_ot": True
    },
    "Canteen": {
        "start": "07:00", "end": "16:00", 
        "break_start": "11:00", "break_end": "12:00",
        "allows_ot": True
    },
    "Shift 1": {
        "start": "06:00", "end": "14:00",
        "break_start": "10:00", "break_end": "10:00",  # No break
        "allows_ot": False
    },
    "Shift 2": {
        "start": "14:00", "end": "22:00",
        "break_start": "18:00", "break_end": "18:00",  # No break  
        "allows_ot": False
    }
}
```

## ‚úÖ Validation Rules

```python
def validate_attendance(employee, date, check_in, check_out):
    # 1. Basic validation
    if not check_in or not check_out or check_out <= check_in:
        raise ValueError("Invalid check in/out times")
    
    # 2. Shift type validation
    shift_type = get_shift_type(employee, date)
    if not shift_type:
        raise ValueError("Cannot determine shift type")
    
    # 3. OT registration validation
    if shift_type in ["Shift 1", "Shift 2"]:
        ot_regs = get_ot_registrations(employee, date)
        if ot_regs:
            raise ValueError("Shift 1/2 cannot have OT registrations")
    
    return True

def validate_maternity_tracking(employee, tracking_record):
    # 1. Date range validation
    if tracking_record.to_date < tracking_record.from_date:
        raise ValueError("Invalid date range")
    
    # 2. Type validation  
    if tracking_record.type not in ["Pregnant", "Maternity Leave", "Young child"]:
        raise ValueError("Invalid maternity type")
    
    # 3. No overlap validation
    existing = get_overlapping_maternity_records(employee, tracking_record)
    if existing:
        raise ValueError("Maternity tracking periods cannot overlap")
    
    return True
```
 

## üìä Testing Checklist

### Test Cases C∆° B·∫£n
- [ ] Day shift b√¨nh th∆∞·ªùng: 8:00‚Üí17:00 = 8h
- [ ] Day shift c√≥ OT: 7:00‚Üí19:00 v·ªõi reg = 10h  
- [ ] Shift 1 kh√¥ng OT: 6:00‚Üí16:00 = 8h
- [ ] Canteen c√≥ OT: 6:00‚Üí18:00 v·ªõi reg = 10h
- [ ] Shift 2 kh√¥ng OT: 14:00‚Üí24:00 = 8h

### Test Cases Maternity
- [ ] Pregnant v·ªÅ s·ªõm: 8:00‚Üí16:00 = 8h (Day)
- [ ] Young child v·ªÅ s·ªõm: 7:00‚Üí15:00 = 8h (Canteen)  
- [ ] H·∫øt benefit: 8:00‚Üí16:00 = 7h
- [ ] Pregnant + OT: 8:00‚Üí18:00 = 9h

### Edge Cases
- [ ] ƒêi mu·ªôn + v·ªÅ s·ªõm
- [ ] OT v∆∞·ª£t approved
- [ ] Multiple OT registrations
- [ ] Thay ƒë·ªïi shift trong th√°ng
- [ ] Maternity overlap periods

 