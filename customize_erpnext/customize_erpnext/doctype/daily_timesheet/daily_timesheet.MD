# Daily Timesheet - Há»‡ Thá»‘ng Cháº¥m CÃ´ng Tá»± Äá»™ng

## ğŸ¯ Tá»•ng Quan

**Daily Timesheet** tá»± Ä‘á»™ng tÃ­nh cháº¥m cÃ´ng tá»«:
- Employee Checkin/Checkout (mÃ¡y cháº¥m cÃ´ng)
- Shift Registration (Ä‘Äƒng kÃ½ ca)
- Overtime Registration (Ä‘Äƒng kÃ½ tÄƒng ca)
- Maternity Tracking (nhÃ¢n viÃªn ná»¯)

### Quy Táº¯c CÆ¡ Báº£n

| Shift | Giá» LÃ m | Nghá»‰ TrÆ°a | OT | Maternity |
|-------|---------|-----------|----|---------__|
| **Day** | 8:00-17:00 | 12:00-13:00 | âœ… | âœ… Vá» 16:00 |
| **Canteen** | 7:00-16:00 | 11:00-12:00 | âœ… | âœ… Vá» 15:00 |
| **Shift 1** | 6:00-14:00 | No break | âŒ | âœ… Vá» 13:00 |
| **Shift 2** | 14:00-22:00 | No break | âŒ | âœ… Vá» 21:00 |

## âš™ï¸ Thuáº­t ToÃ¡n TÃ­nh ToÃ¡n

```
1. XÃ¡c Ä‘á»‹nh Shift Type (Registration > Group > Default)
2. Check Maternity Benefit (tá»« Maternity Tracking)
3. TÃ­nh Working Hours = Morning + Afternoon (khÃ´ng bao gá»“m OT)
4. TÃ­nh Actual OT = Pre-shift + Post-shift
5. Láº¥y Approved OT tá»« registrations
6. Final OT = min(Actual, Approved)
7. Overtime Coefficient (1.5/2.0/3.0)
8. Final OT - With Coefficient = Final OT Ã— Coefficient
```

### Overtime Coefficient
- **NgÃ y thÆ°á»ng (T2-T7)**: 1.5
- **Chá»§ nháº­t**: 2.0
- **NgÃ y lá»…**: 3.0

### Sunday Logic Äáº·c Biá»‡t
Chá»§ nháº­t cÃ³ logic riÃªng:
```python
if is_sunday:
    # Chuyá»ƒn Working Hours â†’ Actual OT
    actual_ot = working_hours
    working_hours = 0
    status = "Sunday"
    overtime_coefficient = 2.0
```

### Maternity Benefit
ÄÆ°á»£c hÆ°á»Ÿng vá» sá»›m 1h mÃ  váº«n tÃ­nh Ä‘á»§ giá»:
- **Pregnant**: Cáº§n `apply_pregnant_benefit = 1` trong Maternity Tracking
- **Maternity Leave**: Tá»± Ä‘á»™ng Ä‘Æ°á»£c hÆ°á»Ÿng
- **Young Child**: Tá»± Ä‘á»™ng Ä‘Æ°á»£c hÆ°á»Ÿng

## ğŸ“Š Káº¿t Quáº£ TÃ­nh ToÃ¡n

### VÃ­ Dá»¥ Ca Day (8:00-17:00)

| TrÆ°á»ng Há»£p | Check In/Out | Working Hours | Final OT | Coefficient | Final OT - With Coeff |
|-------------|--------------|---------------|----------|-------------|---------------------|
| BÃ¬nh thÆ°á»ng | 8:00â†’17:00 | 8h | 0h | 1.5 | 0h |
| CÃ³ OT | 8:00â†’19:00 | 8h | 2h | 1.5 | **3h** |
| Sunday | 8:00â†’17:00 | 0h | 8h | 2.0 | **16h** |
| Sunday + OT | 7:00â†’18:00 | 0h | 2h | 2.0 | **4h** |
| Maternity | 8:00â†’16:00 | **8h** âœ¨ | 0h | 1.5 | 0h |

*âœ¨ = Maternity benefit: vá» sá»›m 1h mÃ  váº«n tÃ­nh Ä‘á»§ giá»*

## ğŸ”„ Auto Sync System

### Real-time Hooks
```python
# Employee Checkin hooks
"after_insert": auto_sync_on_checkin_update
"on_update": auto_sync_on_checkin_update  
"on_trash": auto_cleanup_on_checkin_delete
```

### Scheduled Job
- **21:00 hÃ ng ngÃ y**: Tá»± Ä‘á»™ng sync vÃ  calculate táº¥t cáº£ Daily Timesheet
- Táº¡o records cho employees cÃ³ checkin nhÆ°ng chÆ°a cÃ³ timesheet
- Update táº¥t cáº£ existing records

### Cleanup Logic
Khi xÃ³a Employee Checkin:
- **Náº¿u khÃ´ng cÃ²n checkin nÃ o khÃ¡c trong ngÃ y** â†’ XÃ³a Daily Timesheet
- **Náº¿u cÃ²n checkin khÃ¡c** â†’ Chá»‰ update láº¡i Daily Timesheet

## ğŸ“ˆ Daily Timesheet Report

### ğŸ¯ Hiá»ƒn Thá»‹ Táº¤T Cáº¢ Employees
**Report sáº½ hiá»ƒn thá»‹ Táº¤T Cáº¢ employees Ä‘ang active trong period Ä‘Æ°á»£c chá»n:**
- âœ… **Employees cÃ³ checkin**: Hiá»ƒn thá»‹ vá»›i dá»¯ liá»‡u tháº­t
- âœ… **Employees KHÃ”NG cÃ³ checkin**: Hiá»ƒn thá»‹ vá»›i giÃ¡ trá»‹ 0
- âœ… **Period validation**: Chá»‰ employees active trong period (dá»±a vÃ o joining/relieving date)

### Cá»™t Hiá»ƒn Thá»‹
**LuÃ´n hiá»‡n**: Employee, Employee Name, Group, Check In/Out (HH:MM:SS), Working Hours, Actual OT, Registered OT, Final OT, Status

**Detail Columns** (chá»‰ khi checked):
- Department, Section
- **Overtime Coefficient, Final OT - With Coefficient**
- Late Entry, Early Exit, Maternity Benefit
- Date of Joining, Relieving Date

### Filter Options
- **Date**: Single Date / Date Range / Monthly
- Department, Section, Group, Employee, Status
- **Summary Mode**: Group by employee
- **Detail Columns**: Show/hide extra columns

## ğŸ—ƒï¸ Database Fields

```json
{
  "employee": "Link to Employee",
  "attendance_date": "Date",
  "check_in": "Datetime",
  "check_out": "Datetime",
  "working_hours": "Float (khÃ´ng bao gá»“m overtime)",
  "actual_overtime": "Float",
  "approved_overtime": "Float", 
  "overtime_hours": "Float (= min(actual, approved))",
  "overtime_coefficient": "Float (1.5/2.0/3.0)",
  "final_ot_with_coefficient": "Float (Final OT Ã— Coefficient)",
  "late_entry": "Check",
  "early_exit": "Check",
  "maternity_benefit": "Check",
  "status": "Select"
}
```

## ğŸš€ Implementation Status: âœ… HOÃ€N THÃ€NH

### âœ… Core Features
- Real-time sync tá»« Employee Checkin
- Auto calculation vá»›i maternity benefit
- Sunday logic Ä‘áº·c biá»‡t
- Overtime coefficient system
- Intelligent cleanup khi xÃ³a checkin

### âœ… Report Features  
- Multiple chart types
- Advanced filtering
- Detail Columns control
- HH:MM:SS time format
- Overtime coefficient columns

### âœ… Auto Sync
- Real-time hooks (create/update/delete)
- Daily scheduled job (21:00)
- Error handling & logging
- No duplicates, safe re-run

---

## ğŸ“ Quick Commands

```bash
# Sau khi sá»­a hooks, cháº¡y:
bench --site erp-sonnt.tiqn.local clear-cache
bench build
bench --site erp-sonnt.tiqn.local migrate  
bench restart

# Manual bulk sync:
bench --site erp-sonnt.tiqn.local execute "customize_erpnext.customize_erpnext.doctype.daily_timesheet.scheduler.manual_bulk_sync" --kwargs "{'from_date': '2025-01-01', 'to_date': '2025-01-31'}"
```

## âš™ï¸ Constants & Thresholds (Latest Update)

### Minimum Thresholds
```python
MIN_MINUTES_OT = 15                    # NgÆ°á»¡ng tá»‘i thiá»ƒu tá»•ng OT
MIN_MINUTES_WORKING_HOURS = 10         # NgÆ°á»¡ng tá»‘i thiá»ƒu working hours
MIN_MINUTES_PRE_SHIFT_OT = 60          # NgÆ°á»¡ng tá»‘i thiá»ƒu OT trÆ°á»›c ca
MIN_MINUTES_CHECKIN_FILTER = 10        # Filter cÃ¡c láº§n cháº¥m cÃ´ng < 10 phÃºt
```

### Logic Improvements
- **Multiple Checkin Logic**: Sá»›m nháº¥t = Check In, Muá»™n nháº¥t = Check Out
- **OT Thresholds**: Sá»­ dá»¥ng constants thay vÃ¬ hardcode
- **Special Case**: Check in trÆ°á»›c ca + Check out trÆ°á»›c nghá»‰ trÆ°a â†’ Working hours = Check out - Báº¯t Ä‘áº§u ca
- **Algorithm Dialog**: Hiá»ƒn thá»‹ constants real-time tá»« server
- **Employee Checkins HTML**: ThÃªm cá»™t `custom_reason_for_manual_check_in`

## ğŸ“Š Enhanced UI Features

### Timesheet Algorithm Dialog
- **Button**: "Timesheet Algorithm" trong form
- **Dynamic Constants**: Láº¥y tá»« server real-time
- **Section Constants**: Hiá»ƒn thá»‹ táº¥t cáº£ ngÆ°á»¡ng hiá»‡n táº¡i
- **Comprehensive Guide**: Ca lÃ m viá»‡c, working hours, overtime, coefficients

### Employee Check-ins Display
- **4 Columns**: Time, Check-in Record, Device, Manual Reason
- **Manual Reason Styling**: MÃ u Ä‘á» náº¿u cÃ³, xÃ¡m náº¿u khÃ´ng
- **Responsive Table**: Tá»± Ä‘á»™ng Ä‘iá»u chá»‰nh width

## ğŸ‰ System Status: **FULLY OPERATIONAL + ENHANCED**

- âœ… Real-time sync working
- âœ… Daily job running at 21:00  
- âœ… Reports vá»›i overtime coefficient
- âœ… Maternity benefit logic correct
- âœ… Sunday logic implemented
- âœ… Cleanup hooks active
- âœ… **Constants-based thresholds**
- âœ… **Enhanced multiple checkin logic**
- âœ… **Dynamic algorithm dialog**
- âœ… **Manual checkin reason display**