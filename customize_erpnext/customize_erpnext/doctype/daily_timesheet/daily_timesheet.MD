# Daily Timesheet - Há»‡ Thá»‘ng Cháº¥m CÃ´ng Tá»± Äá»™ng

## ğŸ†• **LATEST UPDATES** (Nhá»¯ng thay Ä‘á»•i má»›i nháº¥t)

### 1. **Lunch Break Overtime (NEW)**
- âœ… **TÃ­nh OT trong giá» nghá»‰ trÆ°a**: Äiá»u kiá»‡n check-in trÆ°á»›c nghá»‰ trÆ°a + check-out sau nghá»‰ trÆ°a + cÃ³ Ä‘Äƒng kÃ½ OT lunch
- âœ… **Logic tÃ­nh**: ToÃ n bá»™ lunch break period vá»›i ngÆ°á»¡ng tá»‘i thiá»ƒu 15 phÃºt
- âœ… **HÃ m má»›i**: `check_lunch_break_ot_registration()` kiá»ƒm tra Ä‘Äƒng kÃ½ OT lunch

### 2. **Enhanced Overtime Formula**
- **TrÆ°á»›c**: `Actual OT = Pre-shift + Post-shift`
- **âœ… Sau**: `Actual OT = Pre-shift + Lunch-break + Post-shift`

### 3. **ğŸ”„ Auto Workflow Integration (NEW)**
- âœ… **Smart Auto-Recalculation**: Khi Shift Registration/Overtime Registration thay Ä‘á»•i â†’ Tá»± Ä‘á»™ng tÃ­nh láº¡i Daily Timesheet
- âœ… **Intelligent Processing**: â‰¤200 records = real-time, >200 records = background processing
- âœ… **Full Lifecycle**: Submit/Cancel/Update after submit Ä‘á»u trigger auto-recalc
- âœ… **Progress Tracking**: Notification vÃ  progress bar cho bulk operations

## ğŸ¯ Tá»•ng Quan

**Daily Timesheet** tá»± Ä‘á»™ng tÃ­nh cháº¥m cÃ´ng tá»«:
- Employee Checkin/Checkout (mÃ¡y cháº¥m cÃ´ng)
- Shift Registration (Ä‘Äƒng kÃ½ ca) **â† CÃ³ Auto-Recalc**
- Overtime Registration (Ä‘Äƒng kÃ½ tÄƒng ca) **â† CÃ³ Auto-Recalc**
- Maternity Tracking (nhÃ¢n viÃªn ná»¯)

### Quy Táº¯c CÆ¡ Báº£n

| Shift | Giá» LÃ m | Nghá»‰ TrÆ°a | OT | Maternity |
|-------|---------|-----------|----|---------__|
| **Day** | 8:00-17:00 | 12:00-13:00 | âœ… | âœ… Vá» 16:00 |
| **Canteen** | 7:00-16:00 | 11:00-12:00 | âœ… | âœ… Vá» 15:00 |
| **Shift 1** | 6:00-14:00 | No break | âŒ | âœ… Vá» 13:00 |
| **Shift 2** | 14:00-22:00 | No break | âŒ | âœ… Vá» 21:00 |

## âš™ï¸ Thuáº­t ToÃ¡n TÃ­nh ToÃ¡n

```
1. XÃ¡c Ä‘á»‹nh Shift Type (Registration > Group > Default)
2. Check Maternity Benefit (tá»« Maternity Tracking)
3. TÃ­nh Working Hours = Morning + Afternoon (khÃ´ng bao gá»“m OT)
4. âœ… TÃ­nh Actual OT = Pre-shift + Lunch-break + Post-shift (NEW)
5. Láº¥y Approved OT tá»« registrations
6. Final OT = min(Actual, Approved)
7. Overtime Coefficient (1.5/2.0/3.0)
8. Final OT - With Coefficient = Final OT Ã— Coefficient
```

### Overtime Coefficient
- **NgÃ y thÆ°á»ng (T2-T7)**: 1.5
- **Chá»§ nháº­t**: 2.0
- **NgÃ y lá»…**: 3.0

### Sunday Logic Äáº·c Biá»‡t
Chá»§ nháº­t cÃ³ logic riÃªng:
```python
if is_sunday:
    # Chuyá»ƒn Working Hours â†’ Actual OT
    actual_ot = working_hours
    working_hours = 0
    status = "Sunday"
    overtime_coefficient = 2.0
```

### Maternity Benefit
ÄÆ°á»£c hÆ°á»Ÿng vá» sá»›m 1h mÃ  váº«n tÃ­nh Ä‘á»§ giá»:
- **Pregnant**: Cáº§n `apply_pregnant_benefit = 1` trong Maternity Tracking
- **Maternity Leave**: Tá»± Ä‘á»™ng Ä‘Æ°á»£c hÆ°á»Ÿng
- **Young Child**: Tá»± Ä‘á»™ng Ä‘Æ°á»£c hÆ°á»Ÿng

## ğŸ“Š Káº¿t Quáº£ TÃ­nh ToÃ¡n

### VÃ­ Dá»¥ Ca Day (8:00-17:00)

| TrÆ°á»ng Há»£p | Check In/Out | Working Hours | Final OT | Coefficient | Final OT - With Coeff |
|-------------|--------------|---------------|----------|-------------|---------------------|
| BÃ¬nh thÆ°á»ng | 8:00â†’17:00 | 8h | 0h | 1.5 | 0h |
| CÃ³ OT | 8:00â†’19:00 | 8h | 2h | 1.5 | **3h** |
| Sunday | 8:00â†’17:00 | 0h | 8h | 2.0 | **16h** |
| Sunday + OT | 7:00â†’18:00 | 0h | 2h | 2.0 | **4h** |
| Maternity | 8:00â†’16:00 | **8h** âœ¨ | 0h | 1.5 | 0h |

*âœ¨ = Maternity benefit: vá» sá»›m 1h mÃ  váº«n tÃ­nh Ä‘á»§ giá»*

## ğŸ”„ Auto Sync System

### Real-time Hooks
```python
# Employee Checkin hooks
"after_insert": auto_sync_on_checkin_update
"on_update": auto_sync_on_checkin_update
"on_trash": auto_cleanup_on_checkin_delete

# âœ… NEW: Workflow Integration Hooks
# Shift Registration hooks
"on_submit": auto_recalc_on_shift_registration_change
"on_cancel": auto_recalc_on_shift_registration_change
"on_update_after_submit": auto_recalc_on_shift_registration_change

# Overtime Registration hooks
"on_submit": auto_recalc_on_overtime_registration_change
"on_cancel": auto_recalc_on_overtime_registration_change
"on_update_after_submit": auto_recalc_on_overtime_registration_change

# âœ… NEW: Employee Maternity Tracking hooks
"validate": check_maternity_tracking_changes  # So sÃ¡nh old vs new TRÆ¯á»šC save
"on_update": auto_recalc_on_maternity_tracking_change  # Recalculate SAU save
```

### Scheduled Job
- **21:00 hÃ ng ngÃ y**: Tá»± Ä‘á»™ng sync vÃ  calculate táº¥t cáº£ Daily Timesheet
- Táº¡o records cho employees cÃ³ checkin nhÆ°ng chÆ°a cÃ³ timesheet
- Update táº¥t cáº£ existing records

### Cleanup Logic
Khi xÃ³a Employee Checkin:
- **Náº¿u khÃ´ng cÃ²n checkin nÃ o khÃ¡c trong ngÃ y** â†’ XÃ³a Daily Timesheet
- **Náº¿u cÃ²n checkin khÃ¡c** â†’ Chá»‰ update láº¡i Daily Timesheet

## ğŸ“ˆ Daily Timesheet Report

### ğŸ¯ Hiá»ƒn Thá»‹ Táº¤T Cáº¢ Employees
**Report sáº½ hiá»ƒn thá»‹ Táº¤T Cáº¢ employees Ä‘ang active trong period Ä‘Æ°á»£c chá»n:**
- âœ… **Employees cÃ³ checkin**: Hiá»ƒn thá»‹ vá»›i dá»¯ liá»‡u tháº­t
- âœ… **Employees KHÃ”NG cÃ³ checkin**: Hiá»ƒn thá»‹ vá»›i giÃ¡ trá»‹ 0
- âœ… **Period validation**: Chá»‰ employees active trong period (dá»±a vÃ o joining/relieving date)

### Cá»™t Hiá»ƒn Thá»‹
**LuÃ´n hiá»‡n**: Employee, Employee Name, Group, Check In/Out (HH:MM:SS), Working Hours, Actual OT, Registered OT, Final OT, Status

**Detail Columns** (chá»‰ khi checked):
- Department, Section
- **Overtime Coefficient, Final OT - With Coefficient**
- Late Entry, Early Exit, Maternity Benefit
- Date of Joining, Relieving Date

### Filter Options
- **Date**: Single Date / Date Range / Monthly
- Department, Section, Group, Employee, Status
- **Summary Mode**: Group by employee
- **Detail Columns**: Show/hide extra columns

## ğŸ—ƒï¸ Database Fields

```json
{
  "employee": "Link to Employee",
  "attendance_date": "Date",
  "check_in": "Datetime",
  "check_out": "Datetime",
  "working_hours": "Float (khÃ´ng bao gá»“m overtime)",
  "actual_overtime": "Float",
  "approved_overtime": "Float", 
  "overtime_hours": "Float (= min(actual, approved))",
  "overtime_coefficient": "Float (1.5/2.0/3.0)",
  "final_ot_with_coefficient": "Float (Final OT Ã— Coefficient)",
  "late_entry": "Check",
  "early_exit": "Check",
  "maternity_benefit": "Check",
  "status": "Select"
}
```

## ğŸš€ Implementation Status: âœ… HOÃ€N THÃ€NH

### âœ… Core Features
- Real-time sync tá»« Employee Checkin
- Auto calculation vá»›i maternity benefit
- Sunday logic Ä‘áº·c biá»‡t
- Overtime coefficient system
- Intelligent cleanup khi xÃ³a checkin

### âœ… Report Features  
- Multiple chart types
- Advanced filtering
- Detail Columns control
- HH:MM:SS time format
- Overtime coefficient columns

### âœ… Auto Sync
- Real-time hooks (create/update/delete)
- Daily scheduled job (21:00)
- Error handling & logging
- No duplicates, safe re-run

---

## ğŸ“ Quick Commands

```bash
# Sau khi sá»­a hooks, cháº¡y:
bench --site erp-sonnt.tiqn.local clear-cache
bench build
bench --site erp-sonnt.tiqn.local migrate  
bench restart

# Manual bulk sync:
bench --site erp-sonnt.tiqn.local execute "customize_erpnext.customize_erpnext.doctype.daily_timesheet.scheduler.manual_bulk_sync" --kwargs "{'from_date': '2025-01-01', 'to_date': '2025-01-31'}"
```

## âš™ï¸ Constants & Thresholds (Latest Update)

### Minimum Thresholds
```python
MIN_MINUTES_OT = 15                    # NgÆ°á»¡ng tá»‘i thiá»ƒu tá»•ng OT
MIN_MINUTES_WORKING_HOURS = 10         # NgÆ°á»¡ng tá»‘i thiá»ƒu working hours
MIN_MINUTES_PRE_SHIFT_OT = 60          # NgÆ°á»¡ng tá»‘i thiá»ƒu OT trÆ°á»›c ca
MIN_MINUTES_CHECKIN_FILTER = 10        # Filter cÃ¡c láº§n cháº¥m cÃ´ng < 10 phÃºt
```

### Logic Improvements
- **Multiple Checkin Logic**: Sá»›m nháº¥t = Check In, Muá»™n nháº¥t = Check Out
- **OT Thresholds**: Sá»­ dá»¥ng constants thay vÃ¬ hardcode
- **Special Case**: Check in trÆ°á»›c ca + Check out trÆ°á»›c nghá»‰ trÆ°a â†’ Working hours = Check out - Báº¯t Ä‘áº§u ca
- **Algorithm Dialog**: Hiá»ƒn thá»‹ constants real-time tá»« server
- **Employee Checkins HTML**: ThÃªm cá»™t `custom_reason_for_manual_check_in`

## ğŸ“Š Enhanced UI Features

### Timesheet Algorithm Dialog
- **Button**: "Timesheet Algorithm" trong form
- **Dynamic Constants**: Láº¥y tá»« server real-time
- **Section Constants**: Hiá»ƒn thá»‹ táº¥t cáº£ ngÆ°á»¡ng hiá»‡n táº¡i
- **Comprehensive Guide**: Ca lÃ m viá»‡c, working hours, overtime, coefficients

### Employee Check-ins Display
- **4 Columns**: Time, Check-in Record, Device, Manual Reason
- **Manual Reason Styling**: MÃ u Ä‘á» náº¿u cÃ³, xÃ¡m náº¿u khÃ´ng
- **Responsive Table**: Tá»± Ä‘á»™ng Ä‘iá»u chá»‰nh width

## ğŸ‰ System Status: **FULLY OPERATIONAL + ENHANCED + WORKFLOW INTEGRATED**

### Core Functions
- âœ… Real-time sync working
- âœ… Daily job running at 21:00
- âœ… Reports vá»›i overtime coefficient
- âœ… Maternity benefit logic correct
- âœ… Sunday logic implemented
- âœ… Cleanup hooks active
- âœ… **Constants-based thresholds**
- âœ… **Enhanced multiple checkin logic**
- âœ… **Dynamic algorithm dialog**
- âœ… **Manual checkin reason display**

### âœ… NEW: Workflow Integration
- âœ… **Lunch Break Overtime**: TÃ­nh OT trong giá» nghá»‰ trÆ°a
- âœ… **Smart Auto-Recalculation**: Shift/Overtime Registration changes trigger auto-recalc
- âœ… **Employee Maternity Integration**: Employee maternity tracking changes trigger auto-recalc
- âœ… **Intelligent Processing**: Background processing cho bulk operations
- âœ… **Error Handling**: Workflow errors khÃ´ng block main operations
- âœ… **Progress Tracking**: Real-time notifications cho users

---

## â“ **TRáº¢ Lá»œI CÃ‚U Há»I: Workflow cÃ³ tá»± Ä‘á»™ng tÃ­nh toÃ¡n láº¡i Daily Timesheet khÃ´ng?**

### âœ… **CÃ“ - HOÃ€N TOÃ€N Tá»° Äá»˜NG**

#### ğŸ”„ Khi Ã¡p dá»¥ng Workflow cho **Shift Registration**:
- **Submit/Cancel/Update after submit** â†’ Tá»± Ä‘á»™ng recalculate affected Daily Timesheet records
- **Smart Detection**: â‰¤200 records = xá»­ lÃ½ ngay, >200 records = background processing
- **Comprehensive Coverage**: Bao gá»“m cáº£ records bá»‹ xÃ³a trong quÃ¡ trÃ¬nh update

#### ğŸ”„ Khi Ã¡p dá»¥ng Workflow cho **Overtime Registration**:
- **Submit/Cancel/Update after submit** â†’ Tá»± Ä‘á»™ng recalculate affected Daily Timesheet records
- **Immediate Impact**: Thay Ä‘á»•i OT registration áº£nh hÆ°á»Ÿng ngay Ä‘áº¿n Actual Overtime calculation
- **âœ… Lunch Break OT**: Há»— trá»£ tÃ­nh OT trong giá» nghá»‰ trÆ°a vá»›i logic má»›i

#### ğŸ”„ Khi thay Ä‘á»•i **Employee Maternity Tracking** (NEW):
- **Update/Insert** â†’ Tá»± Ä‘á»™ng recalculate affected Daily Timesheet records
- **Smart Detection**: Chá»‰ trigger khi cÃ³ thay Ä‘á»•i thá»±c sá»± trong maternity tracking data
- **Comprehensive Coverage**: Bao gá»“m pregnancy period, maternity leave, young child periods
- **Date Range Calculation**: Tá»± Ä‘á»™ng tÃ­nh toÃ¡n cÃ¡c ngÃ y bá»‹ áº£nh hÆ°á»Ÿng dá»±a trÃªn maternity periods
- **Background Processing**: LUÃ”N cháº¡y ngáº§m Ä‘á»ƒ khÃ´ng block save operation, user nháº­n notification khi hoÃ n thÃ nh

##### ğŸ“Š CÃ¡ch tÃ­nh sá»‘ lÆ°á»£ng Daily Timesheet cáº§n recalculate:

**Logic**: Láº¥y UNION cá»§a táº¥t cáº£ ngÃ y trong OLD vÃ  NEW date ranges

```python
# Thu tháº­p ngÃ y tá»« NEW maternity tracking (sau khi thay Ä‘á»•i)
for tracking in current_maternity_tracking:
    for date in range(tracking.from_date, tracking.to_date):
        affected_dates.add((employee, date))

# Thu tháº­p ngÃ y tá»« OLD maternity tracking (trÆ°á»›c khi thay Ä‘á»•i)
for old_tracking in old_maternity_tracking:
    for date in range(old_tracking.from_date, old_tracking.to_date):
        affected_dates.add((employee, date))

# SET tá»± Ä‘á»™ng loáº¡i bá» trÃ¹ng láº·p
total_records = len(affected_dates)
```

**VÃ­ dá»¥**:
- OLD: 2025-04-05 Ä‘áº¿n 2025-09-24 (173 ngÃ y)
- NEW: 2025-04-05 Ä‘áº¿n 2025-09-26 (175 ngÃ y)
- **UNION**: 2025-04-05 Ä‘áº¿n 2025-09-26 = **175 ngÃ y**

**Táº¡i sao cáº§n UNION cáº£ OLD vÃ  NEW?**
- âœ… Náº¿u chá»‰ tÃ­nh NEW: bá» sÃ³t ngÃ y bá»‹ XÃ“A (cáº§n cáº­p nháº­t Ä‘á»ƒ bá» maternity benefit)
- âœ… Náº¿u chá»‰ tÃ­nh OLD: bá» sÃ³t ngÃ y THÃŠM Má»šI (cáº§n cáº­p nháº­t Ä‘á»ƒ thÃªm maternity benefit)
- âœ… UNION cáº£ hai: Ä‘áº£m báº£o recalculate Táº¤T Cáº¢ ngÃ y cÃ³ kháº£ nÄƒng bá»‹ thay Ä‘á»•i

#### ğŸ¯ **Äáº·c Ä‘iá»ƒm cá»§a há»‡ thá»‘ng tá»± Ä‘á»™ng**:
1. **âš¡ Performance Optimized**:
   - Shift/Overtime Registration: â‰¤200 records = real-time, >200 = background
   - **Employee Maternity: LUÃ”N background processing Ä‘á»ƒ save nhanh**
2. **ğŸ›¡ï¸ Error Handling**: Lá»—i trong recalculation khÃ´ng block workflow chÃ­nh
3. **ğŸ‘¤ User Friendly**:
   - Immediate notification khi start processing
   - Progress tracking cho background jobs
   - Completion notification khi done
4. **ğŸ“Š Data Consistency**: Batch commit (100 records/batch) Ä‘á»ƒ Ä‘áº£m báº£o tÃ­nh nháº¥t quÃ¡n
5. **ğŸ¯ Smart Processing**: Chá»‰ recalculate cÃ¡c Daily Timesheet records Ä‘Ã£ tá»“n táº¡i

### âš ï¸ **LÆ°u Ã½ quan trá»ng**:
- Chá»‰ recalculate cÃ¡c Daily Timesheet records **Ä‘Ã£ tá»“n táº¡i**, khÃ´ng táº¡o má»›i records
- Workflow errors sáº½ Ä‘Æ°á»£c log nhÆ°ng khÃ´ng block main operation
- Large operations (>200 records) sáº½ Ä‘Æ°á»£c process trong background vá»›i progress tracking

---

## ğŸ”¥ **Tá»”NG Káº¾T: Auto-Recalculation Triggers**

Há»‡ thá»‘ng Daily Timesheet sáº½ **Tá»° Äá»˜NG** tÃ­nh toÃ¡n láº¡i khi:

1. **âœ… Employee Checkin**: Real-time update khi cÃ³ checkin/checkout má»›i
2. **âœ… Shift Registration**: Submit/Cancel/Update workflow changes
3. **âœ… Overtime Registration**: Submit/Cancel/Update workflow changes
4. **âœ… Employee Maternity Tracking**: Thay Ä‘á»•i trong custom_maternity_tracking table
5. **âœ… Scheduled Job**: Daily sync lÃºc 22:45 hÃ ng ngÃ y

**â†’ Káº¿t quáº£**: Daily Timesheet luÃ´n Ä‘Æ°á»£c update real-time vÃ  chÃ­nh xÃ¡c vá»›i má»i thay Ä‘á»•i liÃªn quan!